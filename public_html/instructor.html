<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Накатка часов</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="loader.css">
</head>
<body>
    <div class="container" style="padding-top: 2em;">
        <div class="row">
            <div class="col-sm">
            </div>
            <div class="col-sm" id="centralContainer">
                <span class="btn btn-primary btn-block" id="instructorName">...</span>
                <p class="mt-2 mb-0">Всего человек: <span id="totalCount">...</span></p>
                <p class="mb-0">Всего ЗП: <span id="totalSalary">...</span></p>
                <div class="accordion mt-3" id="leadsAccordion">
                    <div class="lds-css ng-scope" style="width: 200px; height: 200px; margin: auto;"><div style="width:100%;height:100%" class="lds-pacman"><div><div></div><div></div><div></div></div><div><div></div><div></div></div></div></div>
                </div>
            </div>
            <div class="col-sm">
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="amo.js" crossorigin="anonymous"></script>
    <script>
        function sortByGroups(leadsData) {
            let sortedLeads = {};

            Object.keys(leadsData).forEach(function (leadId) {
                let leadData = leadsData[leadId];
                let groupName = leadData['group'];

                if (typeof (sortedLeads[groupName]) === 'undefined') {
                    sortedLeads[groupName] = {};
                }

                sortedLeads[groupName][leadId] = leadData;
            });

            return sortedLeads;
        }

        $(function () {
            let instructorId = getParameterByName('id');
            loadHours(instructorId)
                .then(function (responseData) {
                    let instructorName = responseData.instructor;
                    let unsortedLeadsData = responseData.leads;
                    let groupsData = responseData.groups;
                    let totalLeadsCount = Object.keys(unsortedLeadsData).length;
                    let sortedLeads = sortByGroups(unsortedLeadsData);
                    let groupNames = Object.keys(sortedLeads);
                    let totalSalary = Object.keys(groupsData).reduce(function (accumulator, groupName) {
                        let group = groupsData[groupName];
                        return accumulator + group.salary;
                    }, 0);

                    $('#leadsAccordion').html("");
                    $('#instructorName').html(instructorName);
                    $('#totalCount').html(totalLeadsCount);
                    $('#totalSalary').html(totalSalary);

                    groupNames.forEach(function (groupName) {
                        let groupLeadsData = sortedLeads[groupName];
                        let leadsId = Object.keys(groupLeadsData);
                        let groupData = groupsData[groupName];

                        $('#leadsAccordion').append("<div class='h6 my-3'>"+
                            "<div class='title-wrapper'>" +
                            "  <div class=\"dropdown\">\n" +
                            "    <button class=\"btn btn-primary dropdown-toggle\" type=\"button\" id=\"dd"+groupName+"\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">\n" +
                            "      Группа " + groupName + "\n" +
                            "    </button>\n" +
                            "    <div class=\"dropdown-menu\" aria-labelledby=\"dd"+groupName+"\">\n" +
                            "      <span class='dropdown-item'>ЗП: " + groupData.salary + "</span>" +
                            "      <span class='dropdown-item'>Человек: " + groupData.people + "</span>" +
                            "      <span class='dropdown-item'>Начало: " + (groupData.start || "-") + "</span>" +
                            "      <span class='dropdown-item'>Конец: " + (groupData.end || "-") + "</span>" +
                            "      <span class='dropdown-item'>Дата экзамена: " + (groupData.exam || "-") + "</span>" +
                            "    </div>\n" +
                            "  </div>" +
                            "</div>");

                        leadsId.forEach(function (leadId) {
                            let leadData = groupLeadsData[leadId];
                            $('#leadsAccordion').append(
                                getCardHTML(
                                    leadData.contact,
                                    leadId,
                                    leadData.hours || "",
                                    leadData.neededHours || "",
                                    leadData.debt || 0,
                                    leadData.phone
                                )
                            );
                        })
                    });


                });

            $(document).on('submit', 'form', function (event) {
                event.preventDefault();

                let $form = $(this);
                let $button = $form.find('button');
                $button
                    .removeClass('btn-danger btn-primary')
                    .addClass('btn-primary')
                    .attr('disabled', 'disabled')
                    .text('Сохранение ...');

                updateHoursData($form)
                    .then(function () {
                        $button.attr('disabled', false).text('Сохранить');
                    })
                    .catch(function () {
                        $button
                            .attr('disabled', false)
                            .removeClass('btn-danger btn-primary')
                            .addClass('btn-danger')
                            .text('Сохранить повторно');
                    });

            });
        });
    </script>
</body>
</html>